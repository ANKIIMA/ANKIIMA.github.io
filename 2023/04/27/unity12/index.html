<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ankiima.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"right","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="上期主要说了New Input System和Root Motion核心机制，这次我们将在Blend Tree中使用Root Motion，配合Character Controller组件和Cinemachine，可以制作一个角色的移动系统了。注意，这里并没有详细讲解如何制作，只包括这三个组件的介绍。可能后面会有专门的博客提供解决方案。">
<meta property="og:type" content="article">
<meta property="og:title" content="unity入门(十二)-Root Motion和Character Controller">
<meta property="og:url" content="https://ankiima.github.io/2023/04/27/unity12/index.html">
<meta property="og:site_name" content="ANKIIMA">
<meta property="og:description" content="上期主要说了New Input System和Root Motion核心机制，这次我们将在Blend Tree中使用Root Motion，配合Character Controller组件和Cinemachine，可以制作一个角色的移动系统了。注意，这里并没有详细讲解如何制作，只包括这三个组件的介绍。可能后面会有专门的博客提供解决方案。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ankiima.github.io/2023/04/27/unity12/1.png">
<meta property="og:image" content="https://ankiima.github.io/2023/04/27/unity12/13.png">
<meta property="og:image" content="https://ankiima.github.io/2023/04/27/unity12/2.png">
<meta property="og:image" content="https://ankiima.github.io/2023/04/27/unity12/3.png">
<meta property="og:image" content="https://ankiima.github.io/2023/04/27/unity12/4.png">
<meta property="og:image" content="https://ankiima.github.io/2023/04/27/unity12/5.png">
<meta property="og:image" content="https://ankiima.github.io/2023/04/27/unity12/6.png">
<meta property="og:image" content="https://ankiima.github.io/2023/04/27/unity12/7.png">
<meta property="og:image" content="https://ankiima.github.io/2023/04/27/unity12/8.png">
<meta property="og:image" content="https://ankiima.github.io/2023/04/27/unity12/9.png">
<meta property="og:image" content="https://ankiima.github.io/2023/04/27/unity12/11.png">
<meta property="og:image" content="https://ankiima.github.io/2023/04/27/unity12/12.png">
<meta property="og:image" content="https://ankiima.github.io/2023/04/27/unity12/10.png">
<meta property="article:published_time" content="2023-04-27T12:36:22.000Z">
<meta property="article:modified_time" content="2024-10-05T08:48:41.548Z">
<meta property="article:author" content="ANKIIMA">
<meta property="article:tag" content="CG">
<meta property="article:tag" content="Unity">
<meta property="article:tag" content="Game">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ankiima.github.io/2023/04/27/unity12/1.png">


<link rel="canonical" href="https://ankiima.github.io/2023/04/27/unity12/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://ankiima.github.io/2023/04/27/unity12/","path":"2023/04/27/unity12/","title":"unity入门(十二)-Root Motion和Character Controller"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>unity入门(十二)-Root Motion和Character Controller | ANKIIMA</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">ANKIIMA</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Blend-Tree%E4%B8%AD%E4%BD%BF%E7%94%A8Root-Motion"><span class="nav-number">1.</span> <span class="nav-text">Blend Tree中使用Root Motion</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">1.1.</span> <span class="nav-text">存在的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E5%90%8C%E8%A7%92%E8%89%B2%E4%BD%BF%E7%94%A8root-motion"><span class="nav-number">1.1.1.</span> <span class="nav-text">不同角色使用root motion</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E4%B8%BB%E6%8E%A7%E5%88%B6%E7%A7%BB%E5%8A%A8%E9%80%9F%E5%BA%A6"><span class="nav-number">1.1.2.</span> <span class="nav-text">自主控制移动速度</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%8A%9B%E5%A4%B1%E6%95%88"><span class="nav-number">1.1.3.</span> <span class="nav-text">重力失效</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%A7%BB%E5%8A%A8%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-number">2.</span> <span class="nav-text">移动控制器</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Cinemachine"><span class="nav-number">3.</span> <span class="nav-text">Cinemachine</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Cinemachine-Brain"><span class="nav-number">3.1.</span> <span class="nav-text">Cinemachine Brain</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Virtual-Machine"><span class="nav-number">3.2.</span> <span class="nav-text">Virtual Machine</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Body"><span class="nav-number">3.2.1.</span> <span class="nav-text">Body</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Aim"><span class="nav-number">3.2.2.</span> <span class="nav-text">Aim</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ANKIIMA"
      src="/images/apple-touch-icon.png">
  <p class="site-author-name" itemprop="name">ANKIIMA</p>
  <div class="site-description" itemprop="description">记录生活的博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">65</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">27</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ANKIIMA" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ANKIIMA" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:anki1667791793@gmail.com" title="E-Mail → mailto:anki1667791793@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ankiima.github.io/2023/04/27/unity12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon.png">
      <meta itemprop="name" content="ANKIIMA">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ANKIIMA">
      <meta itemprop="description" content="记录生活的博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="unity入门(十二)-Root Motion和Character Controller | ANKIIMA">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          unity入门(十二)-Root Motion和Character Controller
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-27 20:36:22" itemprop="dateCreated datePublished" datetime="2023-04-27T20:36:22+08:00">2023-04-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Computer-Graphics/" itemprop="url" rel="index"><span itemprop="name">Computer Graphics</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Computer-Graphics/Engine/" itemprop="url" rel="index"><span itemprop="name">Engine</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Computer-Graphics/Engine/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>上期主要说了New Input System和Root Motion核心机制，这次我们将在Blend Tree中使用Root Motion，配合Character Controller组件和Cinemachine，可以制作一个角色的移动系统了。注意，这里并没有详细讲解如何制作，只包括这三个组件的介绍。可能后面会有专门的博客提供解决方案。</p>
<span id="more"></span>
<h1 id="Blend-Tree中使用Root-Motion"><a href="#Blend-Tree中使用Root-Motion" class="headerlink" title="Blend Tree中使用Root Motion"></a>Blend Tree中使用Root Motion</h1><p>现在我们重新给角色建立一个Blend Tree，然后还是添加三个动画：Idle，Walking，BackwardWalking。确保它们都正确建立了Avatar，并且都具有Root Motion，而且基础设置完成。然后我们使用下面的代码，其实就是将前面的代码简化了，移动交给root motion来完成，我们只负责状态机中Speed变量的赋值。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.InputSystem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Locomotion</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    Animator animator;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> forwardSpeed = <span class="number">1.6f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> backwardSpeed = <span class="number">1.2f</span>;</span><br><span class="line">    <span class="built_in">float</span> targetSpeed;</span><br><span class="line">    <span class="built_in">float</span> currentSpeed;</span><br><span class="line"></span><br><span class="line">    Vector3 movevalue;</span><br><span class="line">    <span class="comment">// Start is called before the first frame update</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        animator = GetComponent&lt;Animator&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Move();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Move</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        currentSpeed = Mathf.Lerp(targetSpeed, currentSpeed, <span class="number">0.9f</span>);</span><br><span class="line">        animator.SetFloat(<span class="string">&quot;Speed&quot;</span>, currentSpeed);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PlayerMove</span>(<span class="params">InputAction.CallbackContext callbackContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//记录玩家输入</span></span><br><span class="line">        Vector2 movement = callbackContext.ReadValue&lt;Vector2&gt;();</span><br><span class="line">        targetSpeed = movement.y &gt; <span class="number">0</span> ? forwardSpeed * movement.y : backwardSpeed * movement.y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个地方值得说明，在我们使用root motion的时候，移动的阈值不是我们确定的，因此需要使用Blend Tree中的阈值计算功能，它会根据动画来计算一个合适的阈值以供参考，下面我们打开Blend Tree的Inspector窗口：</p>
<p><img src="/2023/04/27/unity12/1.png" alt></p>
<p>阈值默认勾选Automate Thresholds，Unity会在最大值和最小值之间平均分布阈值；勾选以后，才能使用下面的选项。</p>
<p>点开Compute Thresholds，选项代表根据动画的变化来计算阈值，含义如下：</p>
<ul>
<li>Speed：下面三个变量组成的三维向量长度；</li>
<li>Velocity X：根据X轴上的速度(左右移动)；</li>
<li>Velocity Y：根据Y轴上的速度(垂直移动)；</li>
<li>Velocity Z：根据Z轴上的速度(前后移动)；</li>
<li>Angular Speed(Rad)：弧度制的角速度；</li>
<li>Angular Speed(Deg)：角度制的角速度；</li>
</ul>
<p>所以，我们这里选择的是Velocity Z，用动画前后移动的速度来计算阈值，就得到了上面的结果。此时运行游戏可以发现前进和后退的速度是不一致的，如果想要它们一致，我们只能调整某个动画的播放速度，因此Unity下面还提供了Adjust Time Scale选项，他有两个选项：</p>
<ul>
<li>Homogeneous Speed：计算出让所有列表中动画root motion速度一致时的播放速度。</li>
<li>Reset Time Scale：重置动画播放速度。</li>
</ul>
<p>注意，计算播放速度时会让待机动画的播放速度改变，因为待机动画没有位移，使得计算出来的速度非常大，我们把它的播放速度设置为1即可。如果你的动画没有root motion，那么也不必使用这个选项。</p>
<h2 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h2><p>现在又回到前面的问题，如果动画播放速度为1，被关联的阈值就代表了角色播放这个动画时的移动速度。角色前进的速度是受限于阈值的，即使我们代码中的速度大于root motion的阈值，Unity也会将超过阈值的值限制。另外，就算我们代码中设置的速度即使是小于阈值的，也没有办法保证角色的移动速度就是这个值，因为混合树根据阈值进行混合的时候有可能会做非线性插值，所以导致代码中的这个速度完全无法控制实际的角色移动。</p>
<p>更重要的是，直接修改阈值可能会导致角色脚滑的情况，因为动画播放速度和实际移动速度不匹配。</p>
<p>那么解决方案就只有一个了，改变动画的播放速度，因为设置动画的播放速度不会受到阈值上限的影响，也能让角色快速移动的时候播放匹配速度的动画：</p>
<ul>
<li>Unity计算动画阈值；</li>
<li>播放速度=希望的速度阈值/计算阈值；</li>
<li>阈值=希望的速度阈值；</li>
</ul>
<p>这样以后原本动画的计算阈值是1.5，而我们希望的速度阈值是1，但是播放速度是1/1.5，所以在我们希望速度阈值下角色确实只有1的速度，而且动画播放速度也是小于1的；如果速度阈值达到了计算阈值1.5，那么播放速度就会变为1。因此这个方法可以做到移动速度和动画播放速度的同步，我们后面都可以这样进行阈值的设置。</p>
<p>当然，这个思路照样有bug，非线性插值会导致代码中速度和关联阈值不一致，所以当代码让关联阈值处于阈值最大值和最小值之间的时候，速度仍然是不可控的，不过这种不精确也是可以接受的。</p>
<p>此外，这个方法还是不通用，因为动画复用在不同的模型上，导致Unity计算出来的阈值也不同，高的角色就走得快，矮的角色就走得慢，使用同样的状态机和动画，明日香就比可莉走得快很多，所以原本root motion设定的速度就不再合适了。</p>
<p>所以综上所述，要让不同的人物使用root motion，最好为每个角色制作自己的状态机，单独设置速度。下面我们解决这两个问题。</p>
<h3 id="不同角色使用root-motion"><a href="#不同角色使用root-motion" class="headerlink" title="不同角色使用root motion"></a>不同角色使用root motion</h3><p>前面我们说过，root motion会计算物体的缩放值，一个物体越小，那么物体其他变换的程度也越小。但是从Transform组件上看，两个人物模型的缩放值都是1，其实在制作Avatar时，unity已经对模型进行了缩放映射，小的模型对标准的Avatar来说要放大，或者让Avatar变小，大的模型反之。这种差异就导致了root motion不同，小模型上的root motion随着Avatar的缩小也缩小了。</p>
<p>解决方法还是调整播放速度，将动画播放速度除以缩放值即可：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">animator.speed = animator.humanScale;</span><br></pre></td></tr></table></figure>
<p>此时腿短的角色就会跑得更快，最后两个角色移动速度就是一致的。如果我们又不想改变整个Animator中动画的播放速度，只改变当前混合树中的动画，此时就要用到Animation State的Multiplier属性了，把上面这个值传递给它就好了。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">animator.SetFloat(<span class="string">&quot;ScaleFactor&quot;</span>, <span class="number">1</span> / animator.humanScale)；</span><br></pre></td></tr></table></figure>
<p>注意，如果一个模型大小在导入Unity的时候不符合要求，应该在该模型的配置中解决，而不是使用Transform组件中的Scale属性来完成，这会导致不必要的计算。</p>
<p><img src="/2023/04/27/unity12/13.png" alt></p>
<h3 id="自主控制移动速度"><a href="#自主控制移动速度" class="headerlink" title="自主控制移动速度"></a>自主控制移动速度</h3><p>即使我们正确修改了播放速度来一定程度上修正移动速度，最后角色还是不会按照设想移动，因为角色的root motion不是匀速的！我们设置的阈值其实是root motion移动的平均值，在Clip的Inspector窗口可以看到Average Velocity，就是Unity计算的阈值。如果打开Clip中的Root属性，选择Curves查看，你会看到真正的的root motion：</p>
<p><img src="/2023/04/27/unity12/2.png" alt></p>
<p>你肯定已经觉得很不妙了，阈值也不是线性的，root motion本身也不是线性的，这意味着角色移动速度完全就是不可控的，即使玩家看不出来，但当我们必须使用其他游戏组件控制对象位移时也不能让root motion完全接管移动了，所以这么复杂而且不精确的东西还有必要使用？</p>
<p>是的，它确实没有必要使用了，对一般的移动来说使用root motion的确解决了脚底打滑的问题，但我们有更好的方案，root motion也并不是一无是处。</p>
<p>这里介绍的方法就是通过刚体配合动画，回想为什么会发生脚底打滑，动画上来说是播放速度和移动速度不匹配，物理上来说是因为没有摩擦力！所以我们得让物理引擎参与进来，给角色添加刚体，碰撞体，冻结刚体在X轴和Y轴上的旋转防止角色倒地，修改脚本代码如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.InputSystem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Locomotion</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    Animator animator;</span><br><span class="line">    Rigidbody rigidbody;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> forwardSpeed = <span class="number">1.6f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> backwardSpeed = <span class="number">1.2f</span>;</span><br><span class="line">    <span class="built_in">float</span> targetSpeed;</span><br><span class="line">    <span class="built_in">float</span> currentSpeed;</span><br><span class="line"></span><br><span class="line">    Vector3 movevalue;</span><br><span class="line">    <span class="comment">// Start is called before the first frame update</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        animator = GetComponent&lt;Animator&gt;();</span><br><span class="line">        animator.SetFloat(<span class="string">&quot;ScaleFactor&quot;</span>, <span class="number">1</span> / animator.humanScale);</span><br><span class="line">        rigidbody = GetComponent&lt;Rigidbody&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnAnimatorMove</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Move();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Move</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        currentSpeed = Mathf.Lerp(targetSpeed, currentSpeed, <span class="number">0.9f</span>);</span><br><span class="line">        animator.SetFloat(<span class="string">&quot;Speed&quot;</span>, currentSpeed);</span><br><span class="line">        rigidbody.velocity = animator.velocity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PlayerMove</span>(<span class="params">InputAction.CallbackContext callbackContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//记录玩家输入</span></span><br><span class="line">        Vector2 movement = callbackContext.ReadValue&lt;Vector2&gt;();</span><br><span class="line">        targetSpeed = movement.y &gt; <span class="number">0</span> ? forwardSpeed * movement.y : backwardSpeed * movement.y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是说，现在我们让Move方法的调用放到OnAnimatorMove中而不是Update，并且接管了角色的移动，如果你回去查看Animator的Apply Root Motion选项，会发现此时它后面变成不可选的描述语句，显示Handled by Script。角色移动的方式就是使用刚体的速度属性，这里还是root motion的速度，但是添加了更多的物理模拟如摩擦力，当然还是不精确的速度，如果你希望的话可以直接将currentSpeed赋值给它，只不过可能会有一点点动画上的不同步。</p>
<p>然后将Animator组件的Update Mode修改为<strong>Animate Physics</strong>，这会让OnAnimatorMove方法中计算角色骨骼位移的Move方法和Fixed Update同步，而且其中动画的计算处于动画系统和Fixed Update计算之后，物理系统计算之前，具体可以看<a target="_blank" rel="noopener" href="https://docs.unity3d.com/cn/2021.3/Manual/ExecutionOrder.html">这里</a>：</p>
<p><img src="/2023/04/27/unity12/3.png" alt></p>
<p>这样我们的动画就比较不错了，简单有效，因为物理模拟而更加真实。不过我们Rigidbody中的重力却出问题了，角色受到的重力加速度很小，这其实还是root motion的冲突，因为具有root motion的动画需要勾选Bake Into Pose，否则Y方向上的移动动画会和重力冲突，所以勾选即可。</p>
<h3 id="重力失效"><a href="#重力失效" class="headerlink" title="重力失效"></a>重力失效</h3><p>重新运行，你发现角色虽然下降了，但是怎么是匀速下降呢？重看上面的OhelnAnimatorMove方法，我们强调它在物理系统之前调用，也就是说，每次物理系统计算出一个合理的速度后，被我们的OnAnimatorMove中的Move方法重置了！</p>
<p>所以我们赋值速度的时候仅改变水平方向速度即可，Y方向的速度设置为rigidbody.y，这样重力的问题就解决啦。</p>
<p>这又导致另一个问题，如果角色水平方向受力了，这个问题不是又发生了吗？如果我想用root motion影响角色Y方向的运动该怎么办？因此，这样的移动方式也不是万能的，具体情况需要你自己权衡。到这里root motion就暂时结束了，下面我们才能正式开始制作移动系统，你也理解了为什么我们要花这么多偏度理解root motion，它是动画和移动的核心。</p>
<h1 id="移动控制器"><a href="#移动控制器" class="headerlink" title="移动控制器"></a>移动控制器</h1><p>前面我们一直在使用root motion来进行角色移动的控制，但是主要还是学习动画系统。为了方便后面开发，我们如果不需要对角色进行物理模拟(也就是不使用RigidBody组件)，可以直接使用Unity的Character Controller来处理简单的移动和碰撞。</p>
<p>确保角色身上没有碰撞体和刚体组件，添加Character Controller组件，各项属性含义如下：</p>
<p><img src="/2023/04/27/unity12/4.png" alt></p>
<ul>
<li>Slope Limit：角色能越过的斜坡角度；</li>
<li>Step Offset：角色能过跨越的台阶高度；</li>
<li>Skin Width：角色发生碰撞时碰撞方向上的最小间隔距离，设置为Radius的十分之一可以防止卡死；</li>
<li>Min Move Distance：最小移动距离，小于该距离的移动会被忽略；</li>
<li>Center：碰撞体中心；</li>
<li>Radius：碰撞体半径；</li>
<li>Height：碰撞体高度；</li>
</ul>
<p>可以看到这个控制器其实也能负责碰撞体的简单工作，接下来打开脚本，在OnAnimatorMove方法中启用移动方法。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CharacterController = GetComponent&lt;CharacterController&gt;();</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnAnimatorMove</span>()</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="comment">//CharacterController.Move(animator.deltaPosition);</span></span><br><span class="line">       CharacterController.SimpleMove(animator.velocity);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>Move方法不具有重力，SimpleMove方法默认启用重力，传入对应参数就配置好控制器了。一般来说，如果使用这个控制器组件，重力需要自己手写。</p>
<h1 id="Cinemachine"><a href="#Cinemachine" class="headerlink" title="Cinemachine"></a>Cinemachine</h1><p>我们仍然使用前面提到的cinemachine制作摄像机。安装cinemachine包后，打开顶部菜单栏新建一个Virtual Camera，添加后可以发现，此时我们场景中的Main Camera多出一个禁用的红色图标，并且自动添加了Cinemachine Brain组件，这个组件和我们新建的虚拟相机一同管理摄像机运行。</p>
<p>绑定之后，Main Camera的某些属性已经无法修改了，而是要通过读取某个虚拟摄像机的数属性来更改。我们可以定义任意数量的虚拟摄像机，并且在它们之间切换。</p>
<h2 id="Cinemachine-Brain"><a href="#Cinemachine-Brain" class="headerlink" title="Cinemachine Brain"></a>Cinemachine Brain</h2><p><img src="/2023/04/27/unity12/5.png" alt></p>
<ul>
<li>Live Camera：读取哪一个虚拟摄像机；</li>
<li>Live Blend：转换到哪一个摄像机，当一个摄像机被禁用，这里会转到下一个启用的摄像机；</li>
<li>Show Debug Text：游戏窗口中显示Live Camera和Live Blend；</li>
<li>Show Camera Frustum：显示摄像机的视锥体；</li>
<li>Ignore Time Scale：相机行为是否受到时间缩放值影响；</li>
<li>World Up Override：当相机Y轴和世界坐标系Y轴夹角大于90°，相机重设方向使得该夹角小于90°；如果给这里添加了对象，那么Up方向就会采用这个物体的Y轴方向。</li>
<li>Update Method：指出相机同步的方法，Fixed Update表示同步物理引擎，Late Update表示同步画面绘制，Smart Upadte表示自动选择，Manual Update表示脚本控制；</li>
<li>Blend Update Method：指明两个虚拟相机之间的切换行为同步的方法，只能选Fixed Update和Late Update。</li>
<li>Default Blend：默认的相机切换模式。</li>
<li>Custom Blends：自定义不同相机的切换模式，点击Create Asset可以创建并添加切换模式；</li>
<li>Events：相机触发的事件；</li>
</ul>
<h2 id="Virtual-Machine"><a href="#Virtual-Machine" class="headerlink" title="Virtual Machine"></a>Virtual Machine</h2><p>在实际开发中，我们通常只修改Cinemachine Brain的配置，读取不同的Virtual Machine配置来实现相机的行为，因此原则上相机有几种行为就是用几个Virtual Machine。</p>
<p><img src="/2023/04/27/unity12/6.png" alt></p>
<ul>
<li>Status：状态，Live表示启用，Standby表示待机且运行，Disabled表示被禁用，点击后面的solo可以让相机立即启用；</li>
<li>Game Window Guides：游戏窗口中显示提示信息；</li>
<li>Save During Play：在Play状态下的修改会被保存；</li>
<li>Priority：优先级较高的摄像机会被启用；</li>
<li>Follow：跟随游戏对象；具体在Body中设置；</li>
<li>Look At：看向游戏对象；具体在Aim中设置；</li>
<li>Standy Update：待机时以什么频率执行刷新；Never表示不计算，Always表示和激活的相机一致；Round Robin表示轮盘赌计算不同的虚拟摄像机；</li>
<li>Lens：镜头设置，FOV，Near Clip和Far Clip都和图形学中一致。Dutch表示斜角镜头的角度。</li>
<li>Transition：相机切换的设置，Blend Hint表示相机切换的行为的物理特征，None表示线性切换，Spherical Position表示球面切换，Cylindrical Postion表示圆柱切换，Screen Space Aim When Target Differ表示当look at的对象不同时在屏幕空间之间切换；Inherit Position表示让虚拟相机移动到相机的位置；</li>
<li>Noise：添加晃动效果；</li>
<li>Extension：额外功能；</li>
</ul>
<p>下面我们进一步介绍Body和Aim两个属性的配置。</p>
<h3 id="Body"><a href="#Body" class="headerlink" title="Body"></a>Body</h3><p><img src="/2023/04/27/unity12/7.png" alt></p>
<p>Body控制摄像机的Position。当Body为Transposer时，表示摄像机会在固定的偏移上跟随游戏对象。偏移通过Follow Offset调整，XYZ的Damping是相机移动的阻尼系数。</p>
<p>而Binding Mode则是摄像机跟随使用的坐标系，有以下选项：</p>
<p><img src="/2023/04/27/unity12/8.png" alt></p>
<ul>
<li>Lock To Target On Assign：当目标被分配给Fllow，或者虚拟摄像机被激活的时候，根据Offset在对象本地坐标系下锁定相对位置，跟随对象；如果对象发生旋转、移动，再次触发Assign，相机位置就会重新根据Offset锁定。也就是世界坐标系改变，但是本地坐标系不变；</li>
</ul>
<p><img src="/2023/04/27/unity12/9.png" alt></p>
<ul>
<li>Lock To Target With World Up：这个比较复杂，飞机飞行有三个旋转轴，分别是偏航Yaw，俯仰Pitch，横滚Roll，可以看这篇<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38800089/article/details/108768388">博客</a>，该模式下摄像机坐标随对象的偏航Yaw轴旋转，而虚拟相机本身自然是不旋转的。该模式下使用Yaw Dampling可以调整旋转的阻尼；</li>
<li>Lock To Target No Roll：相机绕偏航Yaw和俯仰Pitch轴旋转，但不能绕横滚Roll旋转；同样使用Damping设置阻尼；</li>
<li>Lock To Target：此时绕三个轴都可以旋转，还可以选择使用四元数或欧拉角调整阻尼；</li>
<li>World Space：和Lock To Target On Assign类似，只不过在世界坐标系下进行，因此与世界坐标系的相对位置不变；</li>
<li>Simple Follow With World Up：相机不会绕任何一个轴旋转，并且在横向尽量不移动；</li>
</ul>
<p>暂时我们就介绍Transposer一个选项。</p>
<h3 id="Aim"><a href="#Aim" class="headerlink" title="Aim"></a>Aim</h3><p>Aim中调整摄像机的Rotation。</p>
<p>Aim有以下模式：</p>
<p><img src="/2023/04/27/unity12/11.png" alt></p>
<ul>
<li>Do nothing：不旋转；</li>
<li>Composer：标准的Aim模式，让相机看向Look At对象，而且该模式的各项属性和之前我们介绍的Game Window Guides有关。</li>
</ul>
<p><img src="/2023/04/27/unity12/12.png" alt></p>
<p><img src="/2023/04/27/unity12/10.png" alt></p>
<p>提示界面中，黄点代表要对准的目标。Tracked Object Offset是偏移量，调整它可以让相机追踪的对象发生偏移。Lookahead Time表示根据对象的移动速度推算一个偏移量，并施加在摄像机上。Lookahead Smoothing是平滑的速度预测偏移量，可以用来消除镜头抖动。Lookahead Ignore Y会忽略预测垂直方向上的移动。Damping还是阻尼。Screen X和Screen Y则是后面Dead Zone的中心位置。Dead Zone Width和Dead Zone Height则是宽高。Dead Zone是屏幕中的一块矩形，只要Target还在这个区域中，相机就不会发生转动，它在游戏视图中表现为一块透明区域。</p>
<p>而蓝色区域则是Soft Zone，Target落在这里面的时候相机会发生转动，让Target回到Dead Zone，宽高也就不解释了。Bias X和Bias Y则是Soft Zone距离中心的的偏移量。最外层的红色区域是黄点绝不会落入的区域。Center On Active表示相机被启用的时候会把对象放到正中央，不勾选则会放在最近的Dead Zone的边缘。</p>
<p>其余Aim选项我们依然暂时不做介绍。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/CG/" rel="tag"># CG</a>
              <a href="/tags/Unity/" rel="tag"># Unity</a>
              <a href="/tags/Game/" rel="tag"># Game</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/04/26/unity11/" rel="prev" title="unity入门(十一)-动画系统(二)">
                  <i class="fa fa-angle-left"></i> unity入门(十一)-动画系统(二)
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/04/30/unity13/" rel="next" title="unity入门(十三)-动画系统(三)">
                  unity入门(十三)-动画系统(三) <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2022 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa-solid fa-paper-plane"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">ANKIIMA</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
